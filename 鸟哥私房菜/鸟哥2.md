## unix常规

默认shell名词：bash

命令的别名：alias

## 快捷键

tab：文件名补全/命令补全/2次文件提示
ctrl+c：中断当前执行程序
ctrl+d：键盘输入EOF/可以取代exit

## 运行等级

切换等级：init {1-7}
0：关机
3：纯文本
5：图形接口模式
6：重启

## 启动问题

文件系统错误
	错误原因:
		1、断电或不正常关机，导致文件系统错误
		2、硬盘使用率过高或环境不良，硬件损坏
	解决方法：
		软件错误可以用fsck来修复
		1、根目录没坏，修复坏掉的磁盘
		2、根目录坏了，拔掉磁盘，修复第一个磁盘所sdb1
	预防：
		1、妥善保养磁盘
		2、划分不同分区，坏掉的地方不会影响到别的磁区
root密码忘记
	解决方法：
		开机时进入，单人维护模式修改

## 文本编辑常用按键

- 按q 退出
- 按空格 翻页
- /word或?word 文档中的查询功能 大小写n分别控制上下
- 按空格 下一行

## 命令的类型

1、输入后直接显示结果，后返回到命令提示符等待下一个命令
2、输入后进入该命令的环境，结束命令才回到命令提示符

## 命令的格式

commend [-option] paramenter1 paramenter2 pa...
	-option 为缩写
	--option 为全名
	+option 格式

在命令前加上反斜线可以忽略alias选项

多个连续的可以用；隔开

## 命令/文件的用法说明

1、man 指令名
	命令等级说明：man man
		1：shell中可用的
		3：c库
		5：配置文件或文件格式
		8：管理员命令
	查询顺序：
		name，概述
		description，详述
		example，案例			
		options，参数
		see also，其他查询渠道
		file，相关文件
2、info 指令名
	条件：必须在/usr/share/info/中有.info的说明文档，非info的说明文档为man page
3、/usr/share/doc目录中的文件

## 文本编辑器

naon

## 关机

1、先使用sync将缓存在内存中的数据写入磁盘中[shutdown/reboot/halt均在关机前呼叫了]
2、shutdown/reboot/halt/poweroff:呼叫的函数库都差不多

## 命令

- sync：数据同步被写入磁盘
- shutdown：关机
- reboot：重启
- halt：关机
- exit：离开系统
- init：切换系统运行模式
- mount：磁盘挂载[启动自动挂载配置文件/etc/fstab]
- unmount：装置文件卸载
- fdisk：对磁盘进行各种操作，分割、删除、显示等，不能处理2T以上的
- parted：也是对磁盘进行分割等操作，限制比较小
- partprobe：更新partition table
- mkfs【make filesystem】：磁盘格式化
- mke2fs：精细化的此磁盘格式化
- e2label：修改文件系统标头
- mknod：配置设备/FIFO文件,major与minor表示
- fsck【filesystem check】：检查文件系统是否混乱，可能会造成错误
- badblocks：检查是否有坏轨
- df：根据superblock，列出文件系统的整体磁盘使用量，不是内存哦
- du：推估当前目录中的文件占磁盘容量，会直接到文件系统内去搜寻所有的文件数据
- dump2fs：查看文件系统的信息
- tune2fs：可以查看superblock也可转换文件系统ext2->3
- hdparm：调整硬盘参数或测试效能
- mkswap：格式化为swap格式
- swapon：启动swap设备文件
- swapoff：关闭swap设备文件
- 查看时间:date：
  	+%Y/%m/%d格式化日期
    	+%h:%M 格式化时间
- cal：查看日历
- bc：计算器
- ls：查看文件属性
- ll：是ls -l别名
- who：查看在线用户
- su：切换用户
- lp[line print]开头：打印相关命令 *
- 查看系统属性设置：echo $
  		LANG
  		PATHLANG=en_US：临时设置终端语言别名
- PATH=“$PATH”:/XXX：设置path
- ifconfig：查看系统ip
- 改变文件属性和权限
  		chgrp：改变所属群组
    	chown：改变文件拥有者与组
    	chmod：改变文件权限，SUID, SGID, SBIT等等的特性
- cp：复制
- touch：创建文件/修改文件时间
- rm：删除文件
- cat：读取文件位置
- mv：移动文件/更名
- rename：更名
- ln：创建实体或符号链接
- 查看系统的信息
  	uname
    	lsb_release
- cd：变换目录
- pwd：显示目前的目录 - Print Working Directory
- mkdir：创建一个新的目录
- rmdir：删除一个空的目录
- basename：档名
- dirname：目录名 
- cat  由第一行开始显示文件内容
- tac  从最后一行开始显示，可以看出 tac 是 cat 的倒著写！
- nl  显示的时候，顺道输出行号！
- more 一页一页的显示文件内容 --呼叫了less
- less 与 more 类似，但是比 more 更好的是，他可以往前翻页！
- head 只看头几行
- tail 只看尾巴几行
- od    以二进位的方式读取文件内容！
- umask：查看/设置当前使用者创建文件/目录的默认权限
- chattr (修改与配置文件隐藏属性)
- lsattr (显示文件隐藏属性)
- file：观察文件类型
- which：根据PATH查找可运行的文档的位置
- type：与 which相同，但是可以找到bash内建的命令
- whereis：利用数据库文件来寻找特定文件的位置
- locate：利用数据库文件[/var/lib/mlocate ]来寻找相关文件名的文件位置
- find：从磁盘中搜索各种文件，搜索的功能丰富如所有者、时间、名字、权限
- groupadd：建立群组
- useradd：新建
- gzip：压缩命令 - 可以解开gz/z，默认压缩后原文件不在了
- zcat ：可以读取纯文字档被压缩后的压缩档
- bzip2：比gzip更好的压缩比 - bz2
- bzcat：可以读取纯文字档被压缩后的压缩档
- tar：可以将多个目录或文件打包成一个大文件，压缩过的为tarball否则为tarfile
- dump：备份
- restore：恢复备份

## 特殊目录

```
.         代表此层目录
..        代表上一层目录
-         代表前一个工作目录
~         代表『目前使用者身份』所在的家目录
~account  代表 account 这个使用者的家目录(account是个帐号名称)
```

## 文件权限

1. 特殊权限
2. 使用者
3. 群组
4. 其他人
5. root【拥有所有权限】

**设置理由**

提供数据保护或者限定的数据共享

**权限的用途**

- 权限之于文件：能否对内容的处理，以及执行文件
- 权限之于目录：能否对目录内容的处理，以及切换进目录
- 对于目录：rx通常一起存在，否则无法读取

**默认权限**

- root默认umask：022，删w
- 一般用户默认umask：002

**特殊权限**

- SUID：s出现在拥有者x位置上，只对二进制文件有效，用户执行时临时赋予拥有者权限
- SGID：s出现在群组x位置上，对二进制文件或目录有效，有rx权，执行时获得该群组的支持
- SBIT：t出现在other上，只针对目录有效，对目录有wx权，但在删除时只有拥有者和root可

## 文件属性

属性首位

- 一般文件regular：-
- 目录文件directory：d
- 连结文档link：l
- 区块设备block：b
- 字符设备charactrer：c
- 数据接口文件sockets：s
- 数据输送文件pipe：p

文件拓展名【只用来了解用途】：

- .sh：脚本或批处理文件
- Z/tar/tar.gz/zip/tgz：压缩文件
- html/php：网页文件

文件头：

- .：表示隐藏文档

时间

- atime：访问时间
- ctime：状态修改时间
- mtime：内容修改时间

## FHS目录配置标准

- /：根目录，开机系统相关
- /usr(unix software resource)：软件有关
- /var：系统运行过程有关

## 开机文件

- /etc：配置文件
- /bin：重要执行档利用内存虚拟出来的磁盘空间
- /dev：所需要的装置文件
- /lib：执行档所需的函式库与核心所需的模块
- /sbin：重要的系统执行文件

应该和根目录放在同一个分割槽

## 身份信息存储位置

1. 所有账号/ 使用者/root：etc/passwd
2. 个人密码：etc/shadow
3. 组名：etc/group

## 文件系统

linux使用**Ext2/Ext3**文件系统，Ext2是一个索引式文件系统，Ext3是一个日志式文件系统

所有文件会用一个**文件数据库**来保存，默认每天更新一次，可以主动更新，也可以修改配置文件修改更新时间[/etc/updatedb.conf ]

一个可被挂载的数据为一个**文件系统**，传统磁盘与文件系统中，一个分割槽就是一个文件系统，新技术通过LVM和磁盘阵列，导致一个分割槽可以多个，多个分割槽可以化为1个。

**文件数据**：

- 文件实际内容
- 文件权限、文件属性

**数据区块**：

- inode：存放文件的属性和权限，一个文件占用一个inode，同时记录此文件的数据所在的 block 号码
- data block：存放文件的实际数据，若文件太大时，会占用多个 block。
- superblock：存放文件系统的整体信息，包括inode/block的总量、使用量、剩余量， 	以及文件系统的格式与相关信息等

**碎片整理**：需要碎片整理的原因就是文件写入的 block 太过于离散了，此时文件读取的效能将会变的很差所致。这个时候可以透过碎片整理将同一个文件所属的 blocks 汇整在一起，这样数据的读取会比较容易啊！

**目录数据存储形式**：inode记录目录信息，block记录内含文件的inode信息

**运行方式**：采用异步处理的方式对文件进行存取，定时更新脏数据，可以用sync强制写回

**挂载点**：目录即是挂载点，将文件系统和目录树结合的方法为挂载，文件系统，一个挂载点对应一个文件系统，顶层目录的inode为2,文件系统为硬件，目录为软件

**管理**：用VFS【virtual filsystem switch】来管理所有的文件系统

## Ext2区块群组

为了方便管理，格式化的时候以区块群组的方式来划分，每个区块群组都有独立的  	inode/block/superblock 系统，全部的block group组成一个文件系统。内容如下：

**data block**的限制：

- 原则上，block 的大小与数量在格式化完就不能够再改变了(除非重新格式化)；
- 每个 block 内最多只能够放置一个文件的数据；
- 承上，如果文件大于 block 的大小，则一个文件会占用多个 block 数量，block过小inode要记录很多；
- 承上，若文件小于 block ，则该 block 的剩余容量就不能够再被使用了(磁盘空间会浪费)，block过大要浪费很多。

**inode**使用：

- 每个 inode 大小均固定为 128 bytes，可以用多级block间接来记录大量的block
- 每个文件都仅会占用一个 inode 而已；
- 承上，因此文件系统能够创建的文件数量与 inode 的数量有关；
- 系统读取文件时需要先找到 inode，并分析 inode 所记录的权限与用户是否符合，若符合才能够开始实际读取  	block 的内容。

**Superblock**

- block 与 inode 的总量；
- 未使用与已使用的 inode / block 数量；
- block 与 inode 的大小 (block 为 1, 2, 4K，inode 为 128 bytes)；
- filesystem 的挂载时间、最近一次写入数据的时间、最近一次检验磁盘 (fsck) 的时间等文件系统的相关信息；
- 一个 valid bit 数值，若此文件系统已被挂载，则 valid bit 为 0 ，若未被挂载，则 valid bit 为 1 。
- 每个block group都可能有一个superblock，第一个为主，其他都备份。

**Filesystem Description**：描述每个 block group 的开始与结束的 block 号码

**block bitmap**：记录block是否为空

**inode bitmap** ：记录inode是否为空

## Ext2文件操作过程

**文件/目录读取**：

1. 读取根的inode获取权限以及block位置，若有权限继续
2. 根据目录的block记录的inode继续读取，不断重复直到找到

**文件/目录建立**：

1. 先确定用户对于欲新增文件的目录是否具有 w 与 x 的权限，若有的话才能新增；
2. 根据 inode bitmap 找到没有使用的 inode 号码，并将新文件的权限/属性写入；
3. 根据 block bitmap 找到没有使用中的 block 号码，并将实际的数据写入 block 中，且升级 inode 的 block  	指向数据；
4. 将刚刚写入的 inode 与 block 数据同步升级 inode bitmap 与 block bitmap，并升级 superblock 的内容。

## Ext3日志式文件系统

意义：解决文件更新到一般系统卡住，需要检查整个filesystem一致性很慢的问题。

做法：在我们的 filesystem 当中规划出一个区块，该区块专门在记录写入或修订文件时的步骤

1. 预备：当系统要写入一个文件时，会先在日志记录区块中纪录某个文件准备要写入的信息；
2. 实际写入：开始写入文件的权限与数据；开始升级 metadata 的数据；
3. 结束：完成数据与 metadata 的升级后，在日志记录区块当中完成该文件的纪录。

优点：

- 速度：日志让读取头移动更有效
- 数据完整性：可以避免数据损毁
- 可利用性：能快速从系统终止到恢复原样
- 易转换性：ext2可以方便的转换为ext3

## 命令与文件的关系

一、让使用者能进入某目录成为『可工作目录』的基本权限为何：

- 可使用的命令：例如 cd 等变换工作目录的命令；
- 目录所需权限：使用者对这个目录至少需要具有 x 的权限
- 额外需求：如果使用者想要在这个目录内利用 ls 查阅档名，则使用者对此目录还需要 r 的权限。

二、使用者在某个目录内读取一个文件的基本权限为何？

- 可使用的命令：例如本章谈到的 cat, more, less等等
- 目录所需权限：使用者对这个目录至少需要具有 x 权限；
- 文件所需权限：使用者对文件至少需要具有 r 的权限才行！

三、让使用者可以修改一个文件的基本权限为何？

- 可使用的命令：例如 [nano](http://cn.linux.vbird.org/linux_basic/0160startlinux.php#nano) 或未来要介绍的 [vi](http://cn.linux.vbird.org/linux_basic/0310vi.php) 编辑器等；
- 目录所需权限：使用者在该文件所在的目录至少要有 x 权限；
- 文件所需权限：使用者对该文件至少要有 r, w 权限

四、让一个使用者可以创建一个文件的基本权限为何？

- 目录所需权限：使用者在该目录要具有 w,x 的权限，重点在 w 啦！

五、让使用者进入某目录并运行该目录下的某个命令之基本权限为何？

- 目录所需权限：使用者在该目录至少要有 x 的权限；
- 文件所需权限：使用者在该文件至少需要有 x 的权限

## 磁盘的第一个扇区

第一个扇区最重要，里面有：(1)主要启动区(Master boot record, MBR)及分割表(partition table)， 	其中 MBR 占有 446 bytes，而 partition table 则占有 64 bytes。因此分割表最多只能纪录4个分割槽以及59个逻辑分割槽。

## 虚拟磁盘

/dev/shm/：利用内存虚拟出来的磁盘空间

## 文件的链接

- 实体链接hard link：透过文件系统的 inode 连结来产生新档名，而不是产生新文件
- 符号链接/快捷链接Symbolic Link：创建一个独立的文件，而这个文件会让数据的读取指向他  	link 的那个文件的档名

 hard link 只是在某个目录下的 block多写入一个关连数据而已，既不会添加 inode 也不会耗用 block 数量，但是不能跨 Filesystem，不能 link 目录，因为链接目录要将所有档名hardlink，比较复杂。

由 Symbolic link 所创建的文件为一个独立的新的文件，所以会占用掉 inode 与 block

新目录链接数量：新的目录的 link 数为 2 [/.和/]，而上一级目录的 link 数则会添加 1 [/..]

## 添加磁盘

1. 用fdisk对磁盘进行分割，以创建可用的 partition ，再用partprobe进行更新；
2. 对该 partition 进行格式化( format )，以创建系统可用的 filesystem；
3. 若想要仔细一点，则可对刚刚创建好的 filesystem 进行检验；
4. 在 Linux 系统上，需要创建挂载点 ( 亦即是目录 )，并将他挂载上来；

## 单人维护模式

/是read only状态，无法修改，可以通过mount重新挂载

## loop装置挂载

loop device设备是通过影射操作系统上的正常的文件，将文件虚拟的一个虚拟磁盘块设备。

可以在原本的分割槽在不更动原有的环境下制作出你想要的分割槽。

步骤：

1. 用dd创建一个大型空文件
2. 用mkfs格式化
3. 用mount挂载

## 内存置换空间swap

​	swap 的功能就是在应付物理内存不足的情况下所造成的内存延伸记录的功能。

构建swap的方法：

1. 实体分割槽
2. 虚拟内存文件

实体分割步骤：

1. 分割：先使用 fdisk 在你的磁盘中分割出一个分割槽给系统作为 swap 。由于 Linux 的 fdisk  	默认会将分割槽的 ID 配置为 Linux 的文件系统，所以你可能还得要配置一下 system ID 就是了。
2. 格式化：利用创建 swap 格式的『mkswap 装置文件名』就能够格式化该分割槽成为 swap 格式啰
3. 使用：最后将该 swap 装置启动，方法为：『swapon 装置文件名』。
4. 观察：最终透过 free 这个命令来观察一下内存的用量吧！

虚拟内存文件步骤：

1. 用dd新增一个空文件
2. 用mkswap格式化这个文件
3. 用swapon启动文件
4. 使用后可以通过swapoff关闭

如果你的主机支持电源管理模式， 	也就是说，你的 Linux 主机系统可以进入『休眠』模式的话，那么， 	运行当中的程序状态则会被纪录到 swap 去，以作为『唤醒』主机的状态依据！

swap限制：最多32个，最大64g【最大寻址】

## boot sector 与  superblock 的关系

当block==1024bytes时，两者分开block存放

当block>1024bytes时，两者放在同一个block

## 空间浪费

superblock/inode/data block等中介数据都会占用额外的磁盘容量







