#  第二章 进程管理

## 进程

前驱图：用于描述进程之间执行的前后关系（偏序关系）的有向无循环图。

进程上下文：既进程所在的系统环境【CPU的所有寄存器中的值、进程的状态以及堆栈上的内容】。

#### 程序的执行方式

##### 顺序执行

定义：各程序段之间按照某种先后次序顺序执行。

图示：![第二章 程序的顺序执行](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 程序的顺序执行.jpg)

特征：顺序性；封闭性；可再现性。

##### 并发执行

定义：彼此互不依赖的程序同时进行处理。

图示：![第二章 程序的并发执行](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 程序的并发执行.jpg)

特征：间断性；失去封闭性；不可再现性。

#### 进程的定义

进程是程序的**一次执行**。是一个程序与其使用的数据在处理机上顺序执行时**发生的活动**。是程序在一个数据集合上的**运行过程**。是系统进行资源分配和调度的一个独立**单位**。

#### 进程的特征

- 结构特征：进程实体由PCB、程序段、相关数据段**三部分**构成。
- 动态性：由创建而产生，由调度而执行，由撤消而消亡。
- 并发性：多个进程实体**同存**于内存中，且能在一段时问内**同时运行**。
- 独立性：进程实体是一个能**独立运行**、**独立分配资源**和**独立接受调度**的基本单位。
- 异步性：进程按各白独立的、不可预知的**速度**向前推进。

#### 进程(进程实体)和程序(未加入PCB)的区别

1. 存在形态：程序是静态的，进程实体是动态的，有自己的生命周期。
2. 并发性：进程实体是并发的，而未加入PCB的程序不是。
3. 独立性：进程能独立的运行、分配资源、被调度，而未加入PCB的程序不能。
4. 进程和程序不是一一对应的： 一个程序可对应多个进程即多个进程可执行同一程序； 一个进程可以执行一个或几个程序。

#### 进程的状态

##### 三种基本状态

![第二章 进程三种基本状态转换图](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 进程三种基本状态转换图.jpg)

- 就绪：已分配到除CPU以外的所有必要资源后，只要再获得CPU，便可立即执行。
- 执行：进程已获得CPU，其程序正在执行。
- 阻塞：正在执行的进程由于发生某事件而暂时无法继续执行时，便放弃处理机而处于暂停状态。

##### 挂起状态

定义：主动使正在执行的进程暂停，或是让就绪的进行不接受调度的静止状态。

挂起原因：终端用户请求；父进程调用；负荷调节；操作系统的需要。

与阻塞的区别[补充]：挂起是主动的，恢复也是主动的，而阻塞是被动的，无法知晓何时恢复；挂起不释放CPU，而阻塞释放；调度时挂起状态的任务会被忽略，而阻塞的资源到位后就能恢复。

##### 创建状态

已拥有了PCB，但进程所需其余资源未分配，还不能调度运行的状态。保证了进程调度在创建工作完成后进行，也增加了管理的灵活性。

##### 终止状态

进入终止态的进程以后不能再执行，但在操作系统中依然保留一个记录，其中保存状态码和一些计时统计数据，供其它进程收集。一旦其它进程完成了对终止状态进程的信息提取之后，操作系统将删除该进程。

##### 状态的转换

![第二章 进程状态转换图](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 进程状态转换图.jpg)

#### 进程控制块

##### 作用

记录进程的所有信息，在多道程序环境下让一个不能独立运行的程序（含数据）变成能独立运行的进程。建立、删除进程的本质就是建立、回收PCB。

##### 信息

- 进程标识符：唯一的标识一个进程。
- 处理机状态：由处理机的各种寄存器中的内容组成。
- 进程调度信息：进程状态、优先级、调度算法相关信息、事件[阻塞原因]。
- 进程控制信息：程序和数据的地址、同步与通信机制、资源清单、链接指针。

##### 组织结构

- 链接方式：把具有同一状态的PCB，用链接字链接成一个队列。
- 索引方式：根据不同状态建立索引表，记录PCB的地址。

## 进程控制

是进程管理中最基本的功能，进程的创建、终止与转换。

**原语：**由若干条指令组成，不可分割中断，常驻于内存，用于实现进程的通信和控制。

**进程图：**描述进程家族关系的有向树，子进程继承父进程的资源，并在PCB中设置的家族关系表项用以标识进程之间的家族关系，父消子散，子消父可存。

#### 进程的创建

- 引起事件：用户登录；作业调度；提供服务给用户程序；应用请求需要新进程。
- 创建过程：调用创建原语Creat () 创建；申请空白PCB-》分配内存资源-》初始化PCB-》讲进程插入就绪队列。

#### 进程的终止

- 引起事件：正常结束【进程完成】；异常结束【越界错误、保护错、非法指令、特权指令错、运行超时、等待超时、算数运算错误、I/O故障】；外界干预【操作员或者操作系统干预、父进程请求、父进程终止】
- 终止过程：调用终止原语；从PCB集中检索被终止进程的PCB并读出进程状态-》终止进程，若该进程为执行状态则置调度标志为真-》终止其子孙进程-》归还资源给父进程或系统-》将其PCB移除等待其他程序搜集信息。

#### 进程的阻塞和唤醒

- 引起事件：**请求系统服务**但系统不立即满足，资源有时请求唤醒；进程**启动某种操作**后阻塞等待该操作完成后再由中断程序/进程唤醒；**新数据未到达**阻塞等待至数据输入完毕唤醒；系统进程**无新工作可做**阻塞等待新任务到来。
- 阻塞过程：进程自己调用阻塞原语block；停止执行-》更新PCB中的现行状态并将PCB插入相同事件阻塞队列-》转调度程序重新调度新进程；既保留PCB设置新环境。
- 唤醒过程：合作进程用唤醒原语wakeup唤醒；进程从阻塞队列中移出-》改变PCB现在状态为就绪-》PCB移入就绪队列。

#### 进程的挂起与激活

- 引起事件：用户进程请求自己；父进程请求子；
- 挂起过程：系统用挂起原语suspend挂起；检查状态-》并对应改变状态或调度-》PCB复制到制定外存区。
- 激活过程：系统用激活原语active激活；进程从外存调入内存-》检查状态-》修改状态-》判断是否需要调度并执行。

## 进程同步

由于进程的异步性会造成混乱，因此引入同步协调进程的执行次序，使执行具有可再现性。【消费者-生产者问题】【哲学家进餐问题】【读者-写者问题】

#### 进程同步相关概念

- 诸进程的制约关系：间接相互制约关系【资源共享】；直接相互制约关系【进程合作】。
- 临界资源：同一时间只能被一个进程使用，共享采取互斥方式。
- 临界区：在每个进程中访问临界资源的那段代码。前需要加进入区代码以检查临界资源是否被访问以及添加访问标志，后方要加入退出区代码用以撤销标志。其余为剩余区。

![第二章 代码区域图](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 代码区域图.jpg)

- 同步机制遵循的规则：空闲让进；忙则等待；有限等待；让权等待。

#### 信号量机制

- 整型信号量：用于表示**资源数目**的整型量S，除了初始化只能用 wait 与 signal [同步工具]访问，资源+/-1。未遵循让权等待，有忙等。
- 记录型信号量：采用了记录型的数据结构，除了需要一个用于代表资源数目的整型变量value外，还应增加一个进程链表指针L。记录请求信息，然后自我阻塞，解决忙等。但存在死锁。
- AND型信号量：采用AND同步机制，一次性、原子性的分配/释放所有资源，在wait中添加了AND，为Swait/Ssignal
- 信号量集机制：在AND基础上添加对某个资源的需求值，提高分配多个同种资源的效率。
- 利用信号量实现进程互斥：![第二章 资源互制代码格式](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 资源互制代码格式.jpg)
- 实现进程前驱：设 P1 -> P2 ，使他们共享一初值为0的信号量S，在 P1 执行后，用 signal(S) ，在 P2 执行前添加 wait(S) 即可实现。
- 缺陷：每个访问临界资源的进程都需要wait和signal，管理不便，且可能导致死锁。

#### 管程机制

优化信号量机制

- 定义：由代表共享资源的**数据结构**、对该结构实施操作的一组**过程**构成的资源管理模块。
- 组成：管程名称；共享数据结构说明；操作数据结构的一组过程；数据设置初始值的语句。

![第二章 管程示意](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 管程示意.jpg)

- 实现进程互斥：管程封装了共享变量与操作，进程若要访问临界资源必须通过管程，而管程每次只允许一个进程进入。
- 特征：模块化；抽象数据类型；信息掩蔽。【将共享资源用面向对象实现】
- 管程与进程的区别：定义的数据不同【管程是共享公共数据结构 ，进程是私有数据结构PCB】；操作类型【进程是顺序程序相关，管程是同步和初始化相关】；设立目的【进程为了实现并发，管程解决资源互斥使用】；工作方式【进程主动调用管程，管程被动被调用】；并发【进程可，管程与其调用者不可】；存在形态【进程动态、可消失，管程是操作系统中的一个资源管理模块】。
- 条件变量：每个条件设置一个链表，记录因某条件变量而阻塞的所有进程。阻塞时调用 condition.wait 插入等待队列并释放管程，该条件变化condition.signal 选择一个进程唤醒。

## 进程通信

指的是进程间的信息交换，互斥与同步是低级通信，高级通信则是利用操作系统提供的通信命令作为通信工具就传送大量数据的通信。

#### 共享存储器系统

- 基于共享数据结构的通信方式：程序员自己制定数据结构，实现进程间的信息交换，低效，只传递较少信息。
- 基于共享存储区的通信方式：在存储区划分共享存储器，申请者通过分区的关键字链接进程，大数据量。

#### 消息传递系统

- 利用操作系统提供的通信命令以格式化的消息为单位进行数据交换，对程序员是透明的。
- 直接通信方式：利用OS所提供的发送命令，直接把消息发送给目标进程。
- 间接通信方式：进程间的通信需要通过共享数据结构的实体[信箱]。相当于进程和信箱直接通信。可以实现实时/非实时通信。由私有【用户进程，一对一】、公用【操作系统，多对多】、共享信箱【进程，多对一】。
- 问题：通信链路【点-点与多点连接连接方式，单向/双向通信方式，无容量/容量通信链路】；消息格式【消息头与消息正文】；进程同步方式【发送/接收的同步发送或阻塞：汇合、C/S模式、异步独立】。

#### 管道通信系统

- 管道：用于连接一个读进程和一个写进程的共享文件，pip文件，能令其二通信。
- 协调能力：互斥【读/写临界】；同步【写入与输出完成时互相唤醒，交替睡眠】；询问对方是否存在。

#### 消息缓冲队列通信机制

既有容量[带缓冲]的间接通信。

![第二章 消息缓冲通信](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 消息缓冲通信.jpg)

- 数据结构：消息缓冲区【发送者进程标识[sender],消息长度[size],消息正文[text],指向下一个缓冲区的指针[next]】；PCB中有关通信的数据项【消息队列首指针[mq]，消息队列互斥信号量[mutex]，消息队列资源信号量[sm]】。
- 发送原语：![第二章 发送原语](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 发送原语.jpg)

- 接收原语：![第二章 接收原语](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 接收原语.jpg)

## 线程

#### 线程引入原因

引入进程的目的，是为了使多个程序能并发执行，以提高资源利用率和系统吞吐量，但是进程是一个资源拥有者，在对其进行创建、撤销和切换中有较大的时空开销，因此，在操作系统中再引入线程，只作为调度和分派的基本单位，减少程序在并发执行时所付出的时空开销，使OS具有更好的并发性。因此线程又称作“轻型进程”，一个进程能拥有多个线程。

#### 多线程OS中的进程

- 拥有系统资源的基本单位，用户地址空间、同步和通信机制、I/O设备、逻辑地址到内存的地址映射表。
- 可包括多个线程，并为其提供资源和运行环境
- 不是一个可执行的实体，而线程是，但执行相关状态任在，操作进程状态即是操作线程。

#### 线程与进程的比较

- 调度：相同进程内线程切换进程不跟切，不同进程内两者一起切。
- 拥有资源：线程无自己的资源但可以共享访问进程中的资源。
- 并发性：两者均能并发，但线程能在一个进程内并发提高了服务质量与吞吐量。
- 系统开销：线程切换只需涉及寄存器不涉及存储管理方面的操作与资源的回收/分配，且一个进程内的线程具有相同的地址空间无需操作系统内核干预，而线程与之相反，代价更高。

#### 线程的属性

通常一个进程包括多个线程，是花费最小开销的实体。

- 轻型实体：只拥有必须的保持独立运行的资源。TCB、程序计数器等一组寄存器和堆栈。
- 独立调度和分派的基本单位：能独立运行的基本单位。
- 可并发：不论在哪个进程都可以并发。
- 共享进程资源：线程共享同进程内的资源，如地址空间等。

#### 线程的状态

##### 状态参数

可用线程标识符和一组状态参数来描述一个线程

- 寄存器状态：程序计数器、堆栈指针内容
- 堆栈：局部变量、返回地址
- 线程运行状态
- 优先级
- 线程专有存储器：保存线程局部变量拷贝
- 信号屏蔽

##### 运行状态

- 执行状态
- 就绪状态
- 阻塞状态

##### 创建和终止

- 创建过程：进程启动，初始化线程执行 -》线程创建函数并提供参数-》返回线程标识符
- 终止过程：终止不立即释放占有资源-》其他线程执行分离函数-》资源分离

#### 线程间的同步和通信

- 互斥锁：适用于高频的对资源互斥访问的机制，只访一个，读完唤醒阻塞，可尝试性访问。但可能导致死锁，与整型信号量相似。
- 条件变量：当发现资源被占用时，先释放已占用资源，等待临界资源被释放再唤醒。
- 信号量机制：私用信号量【线程创建，只属于特定进程，OS都不晓得也无法恢复/再分配】；公用/系统信号量【又一公开名字供所有进程适用，放在受保护的系统存储区，系统可空】。
- 多读、单写锁[补充]

#### 线程的实现及其实现方式

##### 内核支持线程

- 进程，线程均在操作系统内核的支持下运行。
- 内核通过线程控制块，操作线程。
- 系统调度以线程为单位，采用轮转法线程轮流。
- 优点：多处理器中内核能同时调度；阻塞线程所占处理器资源可以被再分配；线程体量、切换开销小；内核也可以采用多线程技术提高效率。
- 缺点：相较于用户级，线程切换需要从用户态转到内核态，调度是在内核中进行，开销大。
- 实现：为新进程分配可扩大的任务数据区PTDA，其中包含若干线程控制块TCB[标识符、优先级、运行的cpu状态]，新线程在PTDA中分配TCB。
- 调度和切换：与进程相似，有抢占式/非抢占式，时间轮转法，优先权法。

##### 用户级线程

- 线程仅存在于用户空间，切换通常在同进程内，无需内核支持，内核也不晓得。
- 系统的调度一进程为单位，时分运行法进程轮流。
- 优点：线程切换无需到内核空间；调度算法可以是进程专用的，既进程自己来调度线程；用户级线程实现于操作系统平台无关，甚至可在不支持线程机制的OS实现。
- 缺点：阻塞是直接阻塞整个进程；多线程不能利用多处理机，内核一次只给一个进程一个cpu。
- 实现：在用户空间实现，所有线程都具有相同的结构，运行在一中间系统上。
- 中间系统：运行时系统【本质上是用于管理和控制线程的函数，是线程和内核之间的接口，通过系统调用分配资源】；内核控制线程系统【既组合方式】。

##### 组合方式线程

为进程设置轻型进程LWP，用以沟通用户级线程与内核。内核线程与用户级线程通过LWP间隔开来，可各自运行。这些LWP组成“线程池”。

![’第二章 组合方式](C:\Users\25580\Desktop\myporject\Reading-Note\操作系统\picture\第二章 组合方式.jpg)

- 一对一：每个用户线程对应一个内核控制线程，一一对应，并行能力强，但开销较大。
- 多对一：为一个进程内的多个线程分配一个内核控制线程，但每次只允许一个线程进行映射。开销小，效率高，但内核阻塞则整个进程都会被阻塞，且一个进程内多个线程无法实现并行。
- 多对多：结合上述两种模型的优点，数量可自由。